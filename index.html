<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:">
  <title>Soccer Guantone PC Singleplayer</title>
  <style>
    body { color: #ffffff; font-family: sans-serif; overflow: hidden; margin: 0; padding: 0; }
    :root, body.is-fullscreen { background-color: #000000; }
    [hidden] { display: none !important; }
    #app, #loading, #error, #launch { position: absolute; top:0; left:0; width:100%; height:100%; }
    .screen { display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; cursor:default; user-select:none; -webkit-user-select:none; background-color:#000000; }
    #launch { background-color: rgba(0,0,0,0.7); cursor:pointer; }
    .green-flag { width:80px; height:80px; padding:16px; border-radius:100%; background:rgba(255,255,255,0.75); border:3px solid hsla(0,100%,100%,1); display:flex; justify-content:center; align-items:center; box-sizing:border-box; }
    .progress-bar-outer { border:1px solid currentColor; height:10px; width:200px; max-width:200px; }
    .progress-bar-inner { height:100%; width:0; background-color:currentColor; }
    #error-message, #error-stack { font-family: monospace; max-width: 600px; white-space: pre-wrap; user-select: text; -webkit-user-select: text; }
    #error-stack { text-align:left; max-height:200px; overflow:auto; }
  </style>
  <meta name="theme-color" content="#000000">

    <script type="text/javascript">
    // *** SDK GameMonetize.com INIZIALIZZAZIONE ***
    window.SDK_OPTIONS = {
      gameId: "77q8zyf5m7jg48wn59hrij59tdr8l2ak", // <-- IL TUO ID GIOCO (già inserito)
      onEvent: function(a) {
        switch(a.name) {
          case "SDK_GAME_PAUSE":
            // Mute audio e pausa logica del gioco per la pubblicità
            if(window.vm && vm.runtime) vm.runtime.audioEngine.muteAll();
            break;
          case "SDK_GAME_START":
            // Pubblicità finita, riprendi la logica del gioco e avvia
            if(window.vm) {
              if(vm.runtime) vm.runtime.audioEngine.unmuteAll();
              vm.start(); // <-- CORREZIONE CRITICA: AVVIO DEL MOTORE SCRATCH DOPO L'AD
              const launchScreen = document.getElementById('launch');
              if (launchScreen) launchScreen.hidden = true;
            }
            break;
          case "SDK_READY":
            console.log("GameMonetize SDK ready");
            break;
        }
      }
    };
    (function(a,b,c) {
      var d = a.getElementsByTagName(b)[0];
      if (!a.getElementById(c)) {
        var js = a.createElement(b);
        js.id = c;
        js.src = "https://api.gamemonetize.com/sdk.js";
        d.parentNode.insertBefore(js, d);
      }
    })(document, "script", "gamemonetize-sdk");
    </script>
</head>
<body>
  <div id="app"></div>

  <div id="launch" class="screen" hidden title="Click to start">
    <div class="green-flag">
      <svg viewBox="0 0 16.63 17.5" width="42" height="44">
        <defs><style>.cls-1,.cls-2{fill:#4cbf56;stroke:#45993d;stroke-linecap:round;stroke-linejoin:round;}.cls-2{stroke-width:1.5px;}</style></defs>
        <path class="cls-1" d="M.75,2A6.44,6.44,0,0,1,8.44,2h0a6.44,6.44,0,0,1,8.19,0V15.5a6.44,6.44,0,0,0-8.19,0h0a6.44,6.44,0,0,0-7.69,0Z"/>
      </svg>
    </div>
  </div>

  <div id="loading" class="screen">
    <noscript>Enable JavaScript</noscript>
    <div class="progress-bar-outer"><div class="progress-bar-inner" id="loading-inner"></div></div>
  </div>

  <div id="error" class="screen" hidden>
    <h1>Error</h1>
    <details>
      <summary id="error-message"></summary>
      <p id="error-stack"></p>
    </details>
  </div>

  <script src="script.js"></script>
  <script>
    const appElement = document.getElementById('app');
    const launchScreen = document.getElementById('launch'); // Lo manteniamo ma lo nascondiamo dopo l'ad
    const loadingScreen = document.getElementById('loading');
    const loadingInner = document.getElementById('loading-inner');
    const errorScreen = document.getElementById('error');
    const errorScreenMessage = document.getElementById('error-message');
    const errorScreenStack = document.getElementById('error-stack');

    const handleError = (error) => {
      console.error(error);
      if (!errorScreen.hidden) return;
      errorScreen.hidden = false;
      errorScreenMessage.textContent = '' + error;
      let debug = error && error.stack || 'no stack';
      debug += '\nUser agent: ' + navigator.userAgent;
      errorScreenStack.textContent = debug;
    };
    const setProgress = (progress) => {
      if (loadingInner) loadingInner.style.width = progress * 100 + '%';
    };
    const interpolate = (a, b, t) => a + t * (b - a);

    try {
      setProgress(0.1);

      const scaffolding = new Scaffolding.Scaffolding();
      scaffolding.width = 480;
      scaffolding.height = 360;
      scaffolding.resizeMode = "preserve-ratio";
      scaffolding.editableLists = false;
      scaffolding.usePackagedRuntime = true;
      scaffolding.setup();
      scaffolding.appendTo(appElement);

      const vm = scaffolding.vm;
      window.scaffolding = scaffolding;
      window.vm = scaffolding.vm;
      window.Scratch = {
        vm,
        renderer: vm.renderer,
        audioEngine: vm.runtime.audioEngine,
        bitmapAdapter: vm.runtime.v2BitmapAdapter,
        videoProvider: vm.runtime.ioDevices.video.provider
      };

      scaffolding.setUsername("player####".replace(/#/g, () => Math.floor(Math.random() * 10)));
      scaffolding.setAccentColor("#ff4c4c");

      try {
        // Rimosso CloudProvider per semplicità se non strettamente necessario, altrimenti va reinserito
        // scaffolding.addCloudProvider(new Scaffolding.Cloud.WebSocketProvider(["wss://clouddata.turbowarp.org","wss://clouddata.turbowarp.xyz"], "p4-@Soccer Guantone PC.sb3"));
      } catch (error) {
        console.error(error);
      }

      // Rimosso il bottone bandiera verde e i controlli per lasciare il controllo all'SDK
      /*
      const greenFlagButton = document.createElement('img');
      greenFlagButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg...>');
      greenFlagButton.className = 'control-button control-button-highlight green-flag-button';
      greenFlagButton.draggable = false;
      greenFlagButton.addEventListener('click', () => {
        scaffolding.greenFlag();
      });
      scaffolding.addControlButton({
        element: greenFlagButton,
        where: 'top-left'
      });
      */


      vm.setTurboMode(false);
      if (vm.setInterpolation) vm.setInterpolation(false);
      if (vm.setFramerate) vm.setFramerate(30);
      if (vm.renderer.setUseHighQualityRender) vm.renderer.setUseHighQualityRender(false);
      if (vm.setRuntimeOptions) vm.setRuntimeOptions({
        fencing: true,
        miscLimits: true,
        maxClones: 300,
      });
      if (vm.setCompilerOptions) vm.setCompilerOptions({
        enabled: true,
        warpTimer: false
      });
      if (vm.renderer.setMaxTextureDimension) vm.renderer.setMaxTextureDimension(4096);

      if (vm.runtime.setEnforcePrivacy) vm.runtime.setEnforcePrivacy(false);

      if (typeof ScaffoldingAddons !== 'undefined') {
        ScaffoldingAddons.run(scaffolding, {"gamepad":false,"pointerlock":false,"specialCloudBehaviors":false,"unsafeCloudBehaviors":false,"pause":false});
      }

      scaffolding.setExtensionSecurityManager({
        getSandboxMode: () => 'unsandboxed',
        canLoadExtensionFromProject: () => true
      });
      for (const extension of []) {
        vm.extensionManager.loadExtensionURL(extension);
      }

    } catch (e) {
      handleError(e);
    }
  </script>


    <script>
      const getProjectData = (function() {
        const storage = scaffolding.storage;
        storage.onprogress = (total, loaded) => {
          setProgress(interpolate(0.2, 0.98, loaded / total));
        };

        storage.addWebStore(
          [
            storage.AssetType.ImageVector,
            storage.AssetType.ImageBitmap,
            storage.AssetType.Sound,
            storage.AssetType.Font
          ].filter(i => i),
          (asset) => new URL('./assets/' + asset.assetId + '.' + asset.dataFormat, location).href
        );
        return () => new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.onload = () => {
          resolve(xhr.response);
        };
        xhr.onerror = () => {
          if (location.protocol === 'file:') {
            reject(new Error('Zip environment must be used on a website, not on a local file. To fix this error, use the "Plain HTML" environment instead.'));
          } else {
            reject(new Error('Request to load project data failed.'));
          }
        };
        xhr.onprogress = (e) => {
          if (e.lengthComputable) {
            setProgress(interpolate(0.1, 0.2, e.loaded / e.total));
          }
        };
        xhr.responseType = 'arraybuffer';
        xhr.open('GET', "./assets/project.json");
        xhr.send();
      });
      })();
    </script>
  <script>
    const run = async () => {
      const projectData = await getProjectData();
      await scaffolding.loadProject(projectData);
      setProgress(1);
      loadingScreen.hidden = true;
      
      // *** CORREZIONE CRITICA QUI ***
      // Chiamiamo sdk.showBanner() per avviare la pubblicità e l'SDK, che poi avvierà il gioco con SDK_GAME_START
      if (typeof sdk !== 'undefined' && sdk.showBanner !== 'undefined') {
          sdk.showBanner();
      } else {
          // Fallback nel caso l'SDK non si carichi, avvia il gioco direttamente
          scaffolding.start();
          launchScreen.hidden = true;
      }
      // *** FINE CORREZIONE ***
      
    };
    run().catch(handleError);
  </script>
</body>
</html>